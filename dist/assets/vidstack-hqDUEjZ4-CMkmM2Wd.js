import{m as p,n as l,o as n,R as k,p as v,e as o,b as u,i as y,q as d,L as r,l as m,r as w,T as j,Q as b}from"./index-ok-HFIDC.js";import{E as $}from"./vidstack-CqPOw564-fBtm7T6A.js";import{resolveVimeoVideoId as T,getVimeoVideoInfo as P}from"./vidstack-krOAtKMi-C3UUF7YD.js";const g=["bufferend","bufferstart","durationchange","ended","enterpictureinpicture","error","fullscreenchange","leavepictureinpicture","loaded","playProgress","loadProgress","pause","play","playbackratechange","qualitychange","seeked","seeking","timeupdate","volumechange","waiting"];class I extends ${constructor(e,t){super(e),this.b=t,this.$$PROVIDER_TYPE="VIMEO",this.scope=p(),this.ia=l(""),this.uc=l(!1),this.we=null,this.L=null,this.bo=!1,this.Ba=new n(0,0),this.ga=new k(this.lc.bind(this)),this.Zi=null,this.jd=null,this.$n=new Map,this.ve=null,this.cookies=!1,this.title=!0,this.byline=!0,this.portrait=!0,this.color="00ADEF",this.kd=!1;const s=this;this.fullscreen={get active(){return s.bo},supported:!0,enter:()=>this.u("requestFullscreen"),exit:()=>this.u("exitFullscreen")}}get c(){return this.b.delegate.c}get type(){return"vimeo"}get currentSrc(){return this.L}get videoId(){return this.ia()}get hash(){return this.we}get isPro(){return this.uc()}preconnect(){v(this.Ob())}setup(){super.setup(),o(this.xe.bind(this)),o(this._i.bind(this)),o(this.$i.bind(this)),this.c("provider-setup",this)}destroy(){this.A(),this.fullscreen=void 0;const e="provider destroyed";for(const t of this.$n.values())for(const{reject:s}of t)s(e);this.$n.clear(),this.u("destroy")}async play(){return this.u("play")}async pause(){return this.u("pause")}setMuted(e){this.u("setMuted",e)}setCurrentTime(e){this.u("seekTo",e),this.c("seeking",e)}setVolume(e){this.u("setVolume",e),this.u("setMuted",u(this.b.$state.muted))}setPlaybackRate(e){this.u("setPlaybackRate",e)}async loadSource(e){if(!y(e.src)){this.L=null,this.we=null,this.ia.set("");return}const{videoId:t,hash:s}=T(e.src);this.ia.set(t??""),this.we=s??null,this.L=e}xe(){this.A();const e=this.ia();if(!e){this.tc.set("");return}this.tc.set(`${this.Ob()}/video/${e}`),this.c("load-start")}_i(){const e=this.ia();if(!e)return;const t=d(),s=new AbortController;return this.ve=t,P(e,s,this.we).then(i=>{t.resolve(i)}).catch(i=>{t.reject()}),()=>{t.reject(),s.abort()}}$i(){const e=this.uc(),{$state:t,qualities:s}=this.b;if(t.canSetPlaybackRate.set(e),s[r.Pd](!e),e)return m(s,"change",()=>{var a;if(s.auto)return;const i=(a=s.selected)==null?void 0:a.id;i&&this.u("setQuality",i)})}Ob(){return"https://player.vimeo.com"}ng(){const{keyDisabled:e}=this.b.$props,{playsInline:t,nativeControls:s}=this.b.$state,i=s();return{title:this.title,byline:this.byline,color:this.color,portrait:this.portrait,controls:i,h:this.hash,keyboard:i&&!e(),transparent:!0,playsinline:t(),dnt:!this.cookies}}lc(){this.u("getCurrentTime")}nc(e,t){if(this.kd&&e===0)return;const{realCurrentTime:s,realDuration:i,paused:a,bufferedEnd:h}=this.b.$state;if(s()===e)return;const c=s();this.c("time-change",e,t),Math.abs(c-e)>1.5&&(this.c("seeking",e,t),!a()&&h()<e&&this.c("waiting",void 0,t)),i()-e<.01&&(this.c("end",void 0,t),this.kd=!0,setTimeout(()=>{this.kd=!1},500))}pb(e,t){this.c("seeked",e,t)}ub(e){var s;const t=this.ia();(s=this.ve)==null||s.promise.then(i=>{if(!i)return;const{title:a,poster:h,duration:c,pro:f}=i;this.uc.set(f),this.c("title-change",a,e),this.c("poster-change",h,e),this.c("duration-change",c,e),this.ld(c,e)}).catch(()=>{t===this.ia()&&(this.u("getVideoTitle"),this.u("getDuration"))})}ld(e,t){const{nativeControls:s}=this.b.$state,i=s();this.Ba=new n(0,e);const a={buffered:new n(0,0),seekable:this.Ba,duration:e};this.b.delegate.Ha(a,t),i||this.u("_hideOverlay"),this.u("getQualities"),this.u("getChapters")}aj(e,t,s){var i;switch(e){case"getVideoTitle":const a=t;this.c("title-change",a,s);break;case"getDuration":const h=t;this.b.$state.canPlay()?this.c("duration-change",h,s):this.ld(h,s);break;case"getCurrentTime":this.nc(t,s);break;case"getBuffered":w(t)&&t.length&&this.og(t[t.length-1][1],s);break;case"setMuted":this.Oa(u(this.b.$state.volume),t,s);break;case"getChapters":this.bj(t);break;case"getQualities":this.md(t,s);break}(i=this.ao(e))==null||i.resolve()}cj(){for(const e of g)this.u("addEventListener",e)}jb(e){this.ga.aa(),this.c("pause",void 0,e)}hc(e){this.ga.Ya(),this.c("play",void 0,e)}dj(e){const{paused:t}=this.b.$state;!t()&&!this.kd&&this.c("playing",void 0,e)}og(e,t){const s={buffered:new n(0,e),seekable:this.Ba};this.c("progress",s,t)}ej(e){this.c("waiting",void 0,e)}fj(e){const{paused:t}=this.b.$state;t()||this.c("playing",void 0,e)}fe(e){const{paused:t}=this.b.$state;t()&&this.c("play",void 0,e),this.c("waiting",void 0,e)}Oa(e,t,s){const i={volume:e,muted:t};this.c("volume-change",i,s)}bj(e){if(this.pg(),!e.length)return;const t=new j({kind:"chapters",default:!0}),{realDuration:s}=this.b.$state;for(let i=0;i<e.length;i++){const a=e[i],h=e[i+1];t.addCue(new window.VTTCue(a.startTime,(h==null?void 0:h.startTime)??s(),a.title))}this.jd=t,this.b.textTracks.add(t)}pg(){this.jd&&(this.b.textTracks.remove(this.jd),this.jd=null)}md(e,t){this.b.qualities[b.Ja]=e.some(s=>s.id==="auto")?()=>this.u("setQuality","auto"):void 0;for(const s of e){if(s.id==="auto")continue;const i=+s.id.slice(0,-1);isNaN(i)||this.b.qualities[r.ea]({id:s.id,width:i*(16/9),height:i,codec:"avc1,h.264",bitrate:-1},t)}this._a(e.find(s=>s.active),t)}_a({id:e}={},t){if(!e)return;const s=e==="auto",i=this.b.qualities.getById(e);s?(this.b.qualities[b.Xa](s,t),this.b.qualities[r.fa](void 0,!0,t)):this.b.qualities[r.fa](i??void 0,!0,t)}gj(e,t,s){switch(e){case"ready":this.cj();break;case"loaded":this.ub(s);break;case"play":this.hc(s);break;case"playProgress":this.dj(s);break;case"pause":this.jb(s);break;case"loadProgress":this.og(t.seconds,s);break;case"waiting":this.fe(s);break;case"bufferstart":this.ej(s);break;case"bufferend":this.fj(s);break;case"volumechange":this.Oa(t.volume,u(this.b.$state.muted),s);break;case"durationchange":this.Ba=new n(0,t.duration),this.c("duration-change",t.duration,s);break;case"playbackratechange":this.c("rate-change",t.playbackRate,s);break;case"qualitychange":this._a(t,s);break;case"fullscreenchange":this.bo=t.fullscreen,this.c("fullscreen-change",t.fullscreen,s);break;case"enterpictureinpicture":this.c("picture-in-picture-change",!0,s);break;case"leavepictureinpicture":this.c("picture-in-picture-change",!1,s);break;case"ended":this.c("end",void 0,s);break;case"error":this.R(t,s);break;case"seek":case"seeked":this.pb(t.seconds,s);break}}R(e,t){var a;const{message:s,method:i}=e;i==="setPlaybackRate"&&this.uc.set(!1),i&&((a=this.ao(i))==null||a.reject(s))}ue(e,t){e.event?this.gj(e.event,e.data,t):e.method&&this.aj(e.method,e.value,t)}hd(){}async u(e,t){let s=d(),i=this.$n.get(e);return i||this.$n.set(e,i=[]),i.push(s),this.te({method:e,value:t}),s.promise}A(){this.ga.aa(),this.Ba=new n(0,0),this.ve=null,this.Zi=null,this.uc.set(!1),this.pg()}ao(e){var t;return(t=this.$n.get(e))==null?void 0:t.shift()}}export{I as VimeoProvider};
